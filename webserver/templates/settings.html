{# Copyright (C) 2019 Basler AG
   All rights reserved.

   This software may be modified and distributed under the terms
   of the BSD license.  See the LICENSE file for details.
   #}
{% extends "base.html" %}
{% block title %} - Settings{% endblock %}
{% block head %}
    {{ super() }}
    <script type="text/javascript">

        // On document ready this function will be called and initialize the complete website.
        $(document).ready(function () {
            // poll for new messages
            HuConApp.poll();
        }());

        // Check for updates.
        function checkUpdate() {
            $('#updateModal').modal('show');
            $('#consoleLog').html('');
            $('#updateButton').addClass('disabled');

            HuConApp.appendConsoleLog('Check for updates ...', 'green');

            var rpcRequest = HuConApp.getRpcRequest();
            rpcRequest['method'] = 'check_update';
            $.ajax('/API', {
                method: 'POST',
                data: JSON.stringify(rpcRequest),
                dataType: 'json',
                success: function (rpcResponse) {
                    if (HuConApp.isResponseError(rpcResponse)) {
                        alert(rpcResponse[error]);
                    }

                    if (rpcResponse['result']) {
                        $('#updateButton').removeClass('disabled');
                    }
                },
                error: HuConApp.appendErrorLog
            });
        }

        // Call the update script.
        function updateSystem() {
            var rpcRequest = HuConApp.getRpcRequest();
            rpcRequest['method'] = 'update';
            $.ajax('/API', {
                method: 'POST',
                data: JSON.stringify(rpcRequest),
                dataType: 'json',
                error: HuConApp.appendErrorLog
            });
        }

        // Overwrite the default appenConsoleLogMessage function.
        // Append the message, which can be a an array, to the console output.
        HuConApp.appendConsoleLogMessage = function(message, colour) {
            if (colour === undefined) {
                colour = 'black';
            }

            if (message.includes('Error:')) {
                colour = 'red';
            }

            $('#consoleLog').append($('<span>').css('color', colour).text(message)).append($('<br>'));
            $('#consoleLog').scrollTop($('#consoleLog')[0].scrollHeight);
        };

        function listWiFiNetworks() {
            var rpcRequest = HuConApp.getRpcRequest();
            rpcRequest['method'] = 'get_saved_wifi_networks';
            $.ajax('/API', {
                method: 'POST',
                data: JSON.stringify(rpcRequest),
                dataType: 'json',
                success: function (rpcResponse) {
                    if (HuConApp.isResponseError(rpcResponse)) {
                        alert(rpcResponse[error]);
                    }
                    if (rpcResponse['result']) {
                        var i = 0;
                        for (const x of rpcResponse['result']) {
                            console.log(x);
                            var list_item = $("<div class='item' id='id_item_" + i + "'</div>");
                            list_item.append("<div class='right floated content'><i class='minus circle icon'></i></div>");
                            list_item.append("<div class='right floated content'><i class='arrow circle down icon'></i></div>");
                            list_item.append("<div class='right floated content'><i class='arrow circle up icon'></i></div>");
                            if (x.enabled){
                                list_item.append("<i class='wifi big violet icon'></i><div class='content'>" + x.ssid + "</div>");
                            }else{
                                list_item.append("<div class='right floated content'><i class='check circle icon'></i></div>");
                                list_item.append("<i class='wifi big grey icon'></i><div class='content'>" + x.ssid + "</div>");
                            }

                            $('#id_wifi_list').append(list_item);

                            console.log("list_item_test: " + list_item.html());
                            i++;
                        }
                        $('#id_wifi_list_modal').modal({
                            onHide: function(){
                                console.log('hidden');
                            },
                            onShow: function(){
                                console.log('shown');
                            },
                            onApprove: function() {
                                console.log('Approve');
                            }
                        }).modal('show');
                    }
                },
                error: HuConApp.appendErrorLog
            });

        }

        function wifiSearch() {
            console.log("Save Wifi Settings")
            $('#id_wifi_list_modal').modal('approve');

            $('#id_wifi_search_modal').modal({
                onHide: function(){
                    console.log('hidden');

                },
                onShow: function(){
                    console.log('shown');
                },
                onApprove: function() {
                    console.log('Approve');
                }
            }).modal('show');

            var rpcRequest = HuConApp.getRpcRequest();
            rpcRequest['method'] = 'get_wifi_found';
            $.ajax('/API', {
                method: 'POST',
                data: JSON.stringify(rpcRequest),
                dataType: 'json',
                success: function (rpcResponse) {
                    if (HuConApp.isResponseError(rpcResponse)) {
                        alert(rpcResponse[error]);
                    }
                    if (rpcResponse['result']) {
                        var i = 0;
                        for (const x of rpcResponse['result']) {
                            console.log(x);
                            // filter hidden networks
                            if (x.ssid != "") {
                                $('#id_search_wifi_menu').append("<option id='id_search_menu_item_" + i + "'value='" + x.ssid + "' encr='" + x.encryption + "'>" + x.ssid + "</option>");
                                // first item, ssid empty
                                if ($('#id_ssid').val() == "") {
                                    console.log(x.encryption);
                                    $('#id_encryption option[value="' + x.encryption + '"]').prop('selected', true);
                                    $('#id_ssid').val(x.ssid);
                                }
                            }
                            i++;
                        }

                        $('#id_loader').removeClass('active').addClass('disabled');


                        $("#id_search_wifi_menu").on('change', function(){
                            console.log("select changed");
                            var selected_item_id = $('#id_search_wifi_menu option:selected').attr('id');
                            var encryption = $('#'+selected_item_id).attr('encr');
                            var ssid = $('#'+selected_item_id).val();
                            $('#id_encryption option[value="' + encryption + '"]').prop('selected', true);
                            $('#id_ssid').val(ssid);
                        });
                    }
                },
                error: HuConApp.appendErrorLog
            });


        }

    </script>

{% endblock %}

{% block menu %}{% endblock %}
{% block log %}{% endblock %}

{% block main %}
    <div class="center">
        <button onclick="checkUpdate()" class="fluid ui orange button">
            <i class="icon cloud download"></i>
            Update
        </button>
        <p></p>
        <button onclick="listWiFiNetworks()" class="fluid ui orange button">
            <i class="icon wi-fi"></i>
            WiFi
        </button>
        <p></p>
        <button onclick="location.href='index.html'" class="fluid ui blue button">
            <i class="icon home"></i>
            Home
        </button>
    </div>
{% endblock %}

{% block modal %}

    <div id="updateModal" class="ui modal">
        <div class="header">
            <i class="icon cloud download"></i>
            Update
        </div>

        <div class="content">
            <div id="consoleLog" class="codeText" style="height: 300px; overflow-y: scroll;"></div>

            <button onclick="$('#updateModal').modal('hide')" class="ui orange button">Close</button>
            <button onclick="updateSystem()" id="updateButton" class="ui blue button disabled">Update</button>
        </div>
    </div>
    <div id="id_wifi_list_modal" class="ui modal">
        <div class="header">
            <i class="icon wi-fi"></i>
            WiFi List
        </div>
        <div class="content">
            <div class="row">
                <div id="id_wifi_list" class="ui middle aligned divided list"></div>
            </div>
            <div class="ui divider"></div>
            <div class="row actions">
                <button onclick="wifiSearch()" id="id_wifi_search_button" class="ui fluid blue button approve">Add WiFi Network</button>
            </div>
        </div>
    </div>
    <div id="id_wifi_search_modal" class="ui modal">
        <div class="header">
            <i class="icon wi-fi"></i>
            Add new WiFi
            <div id="id_loader" class="ui medium workaround active right floated inline loader"></div>
        </div>

        <div class="content">
            <div class="ui form">
                <div class="field">
                    <label>WiFi Network</label>
                    <select class="ui search dropdown" id="id_search_wifi_menu"></select>
                </div>
                <div class="field">
                    <label>SSID</label>
                    <div class="ui input"><input id="id_ssid" name="ssid" type="text"></div>
                </div>
{#                <div id="id_loader" class="ui massive workaround active centered inline loader"></div>#}
                <div class="field">
                    <label>WiFi Password</label>
                    <div class="ui input"><input id="id_password" name="password" type="password"></div>
                </div>
                <div class="field">
                    <label>Encryption Mode</label>
                    <select class="ui dropdown" id="id_encryption" name="encryption" size="1">
                        <option value="psk">WPA (PSK)</option>
                        <option value="psk2">WPA2 (PSK)</option>
                        <option value="wep">WEP</option>
                        <option value="none">Not secured</option>
                    </select>
                </div>
            </div>
            <div class="row actions">
                <button onclick="saveWiFiSettings()" id="saveButton" class="ui blue button approve">Save</button>
            </div>
{#            <div class="row">#}
{#                <button onclick="$('#wifiModal').modal('hide')" class="ui orange button">Cancel</button>#}
{#                <button onclick="saveWiFiSettings()" id="saveButton" class="ui blue button disabled">Save</button>#}
{#            </div>#}
        </div>

    </div>
{% endblock %}

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="de">

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta http-equiv="cache-control" content="no-cache">
    <meta name="viewport" content="width=device-width, initial-scale=0.5">
    <title>HuCon Robot :) - Blockly</title>

    <!-- Blockly Sourcen -->
    <script type="text/javascript" src="blockly/blockly_compressed.js"></script>
    <script type="text/javascript" src="blockly/blocks_compressed.js"></script>
    <script type="text/javascript" src="blockly/python_compressed.js"></script>
    <script type="text/javascript" src="blockly/en.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="semantic/semantic.min.css">
    <link rel="stylesheet" href="css/main.css">

    <script src="jquery/jquery-3.3.1.min.js"></script>
    <script src="semantic/semantic.min.js"></script>

    <script type="text/javascript" src="js/custom_blocks_machine.js"></script>
    <script type="text/javascript" src="js/custom_blocks_eye.js"></script>
    <script type="text/javascript" src="js/custom_blocks_servo.js"></script>
    <script type="text/javascript" src="js/custom_blocks_motor.js"></script>
    <script type="text/javascript" src="js/custom_blocks_mpu.js"></script>
    <script type="text/javascript" src="js/webserver_blockly.js"></script>

    <script type="text/javascript">
        $(document).ready(function poll() {
            $.ajax('/poll', {
                method: 'POST',
                timeout: 30000, // 30 seconds
                success: function(message){
                    appendConsoleLog(message);
                    poll();
                },
                error: function(){
                    setTimeout(poll, 1000);
                }
            });
        }());

        function openFileModal() {
            $.ajax('/get_file_list', {
                method: 'POST',
                success: function(message) {

                    // clear the list
                    $('#openFileList').html('');

                    // add the files to the empty list
                    var data = JSON.parse(message);
                    for (i=0; i<data['files'].length; i++) {
                        var filename = data['files'][i]
                        if (filename.substr(-4) === '.xml') {
                            $('#openFileList').append('<div onclick="loadFileFromDevice(\'' + filename + '\');" class="item content ok"><div class="header">' + filename.slice(0, -4) + '</div></div>');
                        }
                    }

                    $('#openModal').modal('show');
                },
                error: appendErrorLog
            });
        }

        function loadFileFromDevice(filename) {
            $('#openModal').modal('hide');

            $('#consoleLog').html('');

            var data = {};
            data['filename'] = filename;

            // Store the filename for the save dialog
            $('#saveFilename').val(filename.slice(0, -4));

            $.ajax('/file_load', {
                method: 'POST',
                data: JSON.stringify(data),
                success: function(message) {
                    var data = JSON.parse(message);
                    loadFile(data['data']);
                },
                error: appendErrorLog
            });
        }

        function saveFileModal() {
            $('#saveModal').modal('show');

            $.ajax('/get_file_list', {
                method: 'POST',
                success: function(message) {
                    $('#saveFileList').html('');
                    var data = JSON.parse(message);
                    for (i=0; i<data['files'].length; i++) {
                        var filename = data['files'][i]
                        if (filename.substr(-4) === '.xml') {
                            $('#saveFileList').append('<div onclick="$(\'#saveFilename\').val(\'' + filename.slice(0, -4) + '\');" class="item content ok"><div class="header">' + filename.slice(0, -4) + '</div></div>');
                        }
                    }
                },
                error: appendErrorLog
            });
        }

        function saveFileOnDevice() {
            $('#saveModal').modal('hide');

            $('#consoleLog').html('');

            var data = {};

            // Store the blockly code
            data['filename'] = $('#saveFilename').val() + '.xml';
            data['data'] = getFileData();
            $.ajax('/file_save', {
                method: 'POST',
                data: JSON.stringify(data),
                success: appendConsoleLog,
                error: appendErrorLog
            });

            // Store the python code
            data['filename'] = $('#saveFilename').val() + '.py';
            data['data'] = getPythonCode();
            $.ajax('/file_save', {
                method: 'POST',
                data: JSON.stringify(data),
                success: appendConsoleLog,
                error: appendErrorLog
            });
        }

        function run() {
            $('#consoleLog').html('');
            appendConsoleLog('Loading program ...\n');

            var data = {};
            data['data'] = getPythonCode();
            $.ajax('/execute', {
                method: 'POST',
                data: JSON.stringify(data),
                success: appendConsoleLog,
                error: appendErrorLog
            });

            $('#runButton').addClass('disabled')
            $('#stopButton').removeClass('disabled')
            setTimeout(isRunning, 500 );
        }

        function stop() {
            var data = {};
            $.ajax('/kill', {
                method: 'POST',
                success: appendConsoleLog,
                error: appendErrorLog
            });
        }

        function isRunning() {
            $.ajax('/is_running', {
                method: 'POST',
                success: function(message) {
                    var data = JSON.parse(message);
                    if (data['is_running']) {
                        setTimeout( isRunning, 500 );
                    } else {
                        $('#runButton').removeClass('disabled')
                        $('#stopButton').addClass('disabled')
                    }
                },
                error: appendErrorLog
            });
        }

        function shutdownSystem() {
            $.ajax('/shutdown', {
                method: 'POST',
                error: appendErrorLog
            });
        }

    </script>

<head>
</head>
<body>

    <div class="container">

        <div id="headerArea">
            <button onclick="window.open('https://github.com/juwis/hackerschool')" class="circular ui icon button" style="position: relative;">
                <i class="icon github"></i>
                <div class="floating ui blue label" id="version">error</div>
                GitHub
            </button>

            <button onclick="shutdownSystem()" class="circular ui icon button"style="top: 8px; right: 8px; position: absolute;">
                <i class="icon power off"></i>
            </button>
        </div>

        <div id="buttonArea" class="spaceBottom">
            <div class="ui buttons">
                <button onclick="newFile()" class="ui orange labeled icon button">
                    <i class="file icon"></i>
                    New
                </button>
                <button onclick="openFileModal()" class="ui orange labeled icon button">
                    <i class="folder open icon"></i>
                    Open
                </button>
                <button onclick="saveFileModal()" class="ui orange labeled icon button">
                    <i class="save icon"></i>
                    Save
                </button>
            </div>
            <div class="ui buttons">
                <button id="runButton" onclick="run()" class="ui orange labeled icon button">
                    <i class="play icon"></i>
                    Run
                </button>
                <button id="stopButton" onclick="stop()" class="ui orange labeled icon button disabled">
                    <i class="stop icon"></i>
                    Stop
                </button>
            </div>
            <div class="ui buttons">
                <button id="codeButton" onclick="toggleCodeView()" class="ui orange labeled icon button active">
                    <i class="code icon"></i>
                    Code
                </button>
            </div>
            <button onclick="location.href='index.html'" class="ui blue right floated labeled icon button" style="left: 0px;">
                Index
                <i class="home icon"></i>
            </button>
        </div>

        <div id="mainArea" class="spaceBottom spaceRight shortWidth">
            <div id="blocklyDiv"></div>
        </div>

        <div id="codeArea" class="spaceBottom">
            <div class="ui form">
                <div class="field">
                    <label>Python Code</label>
                    <div id="pythonCode" class="codeText"># Let's start ...</div>
                </div>
            </div>
        </div>

        <div id="logArea">
            <div class="ui form">
                <div class="field">
                    <label>Console Log</label>
                    <div id="consoleLog" class="codeText"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="openModal" class="ui modal">
        <div class="header">
            Open file
        </div>
        <div class="scrolling content">
            <div id="openFileList" class="ui middle aligned selection list"></div>
        </div>
        <div class="actions">
            <div class="ui orange cancel button">
                Cancel
            </div>
        </div>
    </div>

    <div id="saveModal" class="ui modal">
        <div class="header">
            Save file
        </div>
        <div class="scrolling content">
            <div id="saveFileList" class="ui middle aligned selection list"></div>
        </div>
        <div class="ui form content">
            <div class="field">
                <input type="text" id="saveFilename" placeholder="Filename">
            </div>
            <button onclick="$('#saveModal').modal('hide')" class="ui orange button" type="cancel">Cancel</button>
            <button onclick="saveFileOnDevice()" class="ui blue right button" type="submit">Save</button>
        </div>
    </div>
</body>
</html>
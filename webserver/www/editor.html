<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="de">

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta http-equiv="cache-control" content="no-cache">
    <meta name="viewport" content="width=device-width, initial-scale=0.5">
    <title>HuCon Robot :) - Python Editor</title>

    <!-- Ace code editor -->
    <script type="text/javascript" src="ace/ace.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="semantic/semantic.min.css">
    <link rel="stylesheet" href="css/main.css">

    <script src="jquery/jquery-3.3.1.min.js"></script>
    <script src="semantic/semantic.min.js"></script>

    <script type="text/javascript" src="js/webserver.js"></script>

    <script type="text/javascript">
        var editor;

        // Ask the user to go before he goes.
        $(window).bind("beforeunload", function(){
            return "Do you really want to go?\nAll your unsaved data will be lost.";
        });

        // On document ready this function will be called and initialize the complete website.
        $(document).ready(function () {

            // Load the extra template content
            $('#headerArea').load('template/header.html', updateVersion);
            $('#menuArea').load('template/menu.html', configureMenu);
            $('#logArea').load('template/console.html', showConsole);
            $('#openModal').load('template/open.html');
            $('#saveModal').load('template/save.html');
            $('#buttonModal').load('template/button.html');

            // Update the version information on the ui
            updateVersion();

            // Setup the editor
            editor = ace.edit('editor');
            editor.setTheme('ace/theme/xcode');
            editor.session.setMode('ace/mode/python');
            editor.$blockScrolling = Infinity
            editor.setShowPrintMargin(false);
            editor.session.setUseWrapMode(true);

            // poll for new messages
            poll();

            newFile();
        });

        // Hide the code button from the menu.
        function configureMenu() {
            $('#fileDropDown').hide();
            $('#codeButton').hide();
        }

        // Clear the editor and remove the filename.
        function newFile() {
            editor.setValue('# Write down your code ...\n', 1);
            $('#consoleLog').html('');
            $('#saveFilename').val('');
        }

        // Load the file list and show the open file modal.
        function openFileModal() {
            $.ajax('/get_file_list', {
                method: 'POST',
                dataType: 'json',
                success: function(data) {

                    // clear the list
                    $('#openFileList').html('');

                    // add the files to the empty list
                    for (i=0; i<data['files'].length; i++) {
                        var filename = data['files'][i];
                        if (filename.substr(-3) === '.py') {
                            $('#openFileList').append('<div onclick="loadFileFromDevice(\'' + filename + '\');" class="item content ok"><div class="header">' + filename.slice(0, -3) + '</div></div>');
                        }
                    }

                    $('#openModal').modal('show');
                },
                error: appendErrorLog
            });
        }

        // Hide the open file modal and load the content from the file.
        function loadFileFromDevice(filename) {
            $('#openModal').modal('hide');
            $('#consoleLog').html('');

            var data = {};
            data['filename'] = filename;

            // Store the filename for the save dialog
            $('#saveFilename').val(filename.slice(0, -3));

            $.ajax('/file_load', {
                method: 'POST',
                data: JSON.stringify(data),
                dataType: 'json',
                success: function(data) {
                    if (data['data']) {
                        editor.setValue(data['data'], -1);
                    }
                },
                error: appendErrorLog
            });
        }

        // Show the save file modal and load the file list from the device.
        function saveFileModal() {
            $('#saveModal').modal('show');

            $.ajax('/get_file_list', {
                method: 'POST',
                dataType: 'json',
                success: function(data) {
                    $('#saveFileList').html('');
                    for (i=0; i<data['files'].length; i++) {
                        var filename = data['files'][i];
                        if (filename.substr(-3) === '.py') {
                            $('#saveFileList').append('<div onclick="$(\'#saveFilename\').val(\'' + filename.slice(0, -3) + '\');" class="item content ok"><div class="header">' + filename.slice(0, -3) + '</div></div>');
                        }
                    }
                },
                error: appendErrorLog
            });
        }

        // Save the file on the device and hide the file save modal.
        function saveFileOnDevice() {
            $('#saveModal').modal('hide');

            $('#consoleLog').html('');

            var data = {};

            // Store the python code
            data['filename'] = $('#saveFilename').val() + '.py';
            data['data'] = editor.getValue();
            $.ajax('/file_save', {
                method: 'POST',
                data: JSON.stringify(data),
                success: appendConsoleLog,
                error: appendErrorLog
            });
        }

        // Return the python code.
        function getPythonCode() {
            return editor.getValue();
        }

    </script>

<head>
</head>
<body>

    <div class="container">
        <div id="headerArea"></div>
        <div id="menuArea" class="ui top attached menu"></div>
        <div id="mainArea" class="ui attached segment">
            <pre id="editor"></pre>
        </div>
        <div id="logArea" class="ui bottom attached"></div>
    </div>

    <div id="openModal" class="ui modal"></div>
    <div id="saveModal" class="ui modal"></div>
    <div id="buttonModal" class="ui modal"></div>

</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="de">

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta http-equiv="cache-control" content="no-cache">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HuCon Robot :) - Mobile</title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="semantic/semantic.min.css">
    <link rel="stylesheet" href="css/main.css">

    <script src="jquery/jquery-3.3.1.min.js"></script>
    <script src="semantic/semantic.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function poll() {
            $.ajax('/poll', {
                method: 'POST',
                timeout: 30000, // 30 seconds
                success: function(message){
                    appendConsoleLog(message);
                    poll();
                },
                error: function(){
                    setTimeout(poll, 1000);
                }
            });
        }());

        $(document).ready(function () {
            $.ajax('/get_version', {
                method: 'POST',
                success: function(message) {
                    var data = JSON.parse(message);
                    $('#version').html(data['version']);
                },
                error: function(){
                    $('#version').html('error');
                }
            });

            $.ajax('/get_file_list', {
                method: 'POST',
                success: function(message) {
                    var data = JSON.parse(message);
                    var values = Array();
                    var isFirst = true;

                    for (i=0; i<data['files'].length; i++) {
                        var filename = data['files'][i]
                        if (filename.endsWith('.py')) {
                            values.push({name: filename.slice(0, -3), value: filename, selected: isFirst});
                            isFirst = false;
                        }
                    }

                    $('#fileDropDown').dropdown({
                        values: values
                    });
                },
                error: function(){
                    appendConsoleLog('Could not get a file from the device.');
                }
            });

        });

        function run() {
            $('#consoleLog').html('');
            appendConsoleLog('Loading program ...\n');

            var data = {};
            data['filename'] = document.getElementById('filename').value;
            $.ajax('/run', {
                method: 'POST',
                data: JSON.stringify(data),
                success: appendConsoleLog
            });

            $('#runButton').addClass('disabled')
            $('#stopButton').removeClass('disabled')
            setTimeout(isRunning, 500 );
        }

        function stop() {
            var data = {};
            $.ajax('/kill', {
                method: 'POST',
                success: function () {
                    appendConsoleLog('Application stopped.\n');
                }
            });
        }

        function isRunning() {
            $.ajax('/is_running', {
                method: 'POST',
                success: function(message) {
                    var data = JSON.parse(message);
                    if (data['is_running']) {
                        setTimeout( isRunning, 500 );
                    } else {
                        $('#runButton').removeClass('disabled')
                        $('#stopButton').addClass('disabled')
                    }
                },
                error: function() {
                    appendConsoleLog('Error during run.');
                }
            });
        }

        function appendConsoleLog(message) {
            $('#consoleLog').append(message.replace(/\n/g, '<br>'));
            $("#logArea").scrollTop($("#logArea")[0].scrollHeight);
        }

        function shutdownSystem() {
            $.ajax('/shutdown', {
                method: 'POST'
            });
        }

    </script>
<head>
</head>
<body>

    <div class="container">

        <div id="headerArea">
            <button onclick="window.open('https://github.com/juwis/hackerschool')" class="circular ui icon button" style="position: relative;">
                <i class="icon github"></i>
                <div class="floating ui blue label" id="version"></div>
                GitHub
            </button>

            <button onclick="shutdownSystem()" class="circular ui icon button"style="top: 8px; right: 8px; position: absolute;">
                <i class="icon power off"></i>
            </button>
        </div>

        <div id="buttonArea" class="spaceBottom">

            <div id="fileDropDown" class="ui selection dropdown">
                <input type="hidden" id="filename">
                <i class="dropdown icon"></i>
                <div class="default text"></div>
                <div class="menu"></div>
            </div>

            <div class="ui buttons">
                <button id="runButton" onclick="run()" class="ui orange labeled icon button">
                    <i class="play icon"></i>
                    Run
                </button>
                <button id="stopButton" onclick="stop()" class="ui orange labeled icon button disabled">
                    <i class="stop icon"></i>
                    Stop
                </button>
            </div>
            <button onclick="location.href='index.html'" class="ui blue right floated labeled icon button" style="left: 0px;">
                Index
                <i class="home icon"></i>
            </button>
        </div>

        <div id="logArea" style="height: calc(100% - 180px);">
            <div class="ui form">
                <div class="field">
                    <label>Console Log</label>
                    <div id="consoleLog" class="codeText"></div>
                </div>
            </div>
        </div>

    </div>

</body>
</html>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="de">

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta http-equiv="cache-control" content="no-cache">
    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <title>HuCon Robot :) - Settings</title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="semantic/semantic.min.css">
    <link rel="stylesheet" href="css/main.css">

    <script src="jquery/jquery-3.3.1.min.js"></script>
    <script src="semantic/semantic.min.js"></script>

    <script type="text/javascript" src="js/webserver.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            $.ajax('/get_version', {
                method: 'POST',
                dataType: 'json',
                success: function(data) {
                    $('#version').html(data['version']);
                },
                error: appendErrorLog
            });

            // poll for new messages
            poll();
        }());

        function savePassword(remove) {
            oldUsername = document.getElementById('current_username').value;
            oldPassword = document.getElementById('current_password').value;
            newUsername = document.getElementById('new_username').value;
            newPassword = document.getElementById('new_password').value;
            confirmPassword = document.getElementById('new_password_confirm').value;

            var data = {};
            data['oldKey'] = '';
            data['newKey'] = '';
            data['remove'] = remove;

            if (oldUsername != '' || oldPassword != '') {
                data['oldKey'] = btoa(oldUsername + ':' + oldPassword);
            }

            if (!remove) {
                if (newUsername == '' || newPassword == '' || confirmPassword == '') {
                    alert('You must fill the new password.');
                    return
                }

                if (newPassword != confirmPassword) {
                    alert('The new and confirmed password are not the same.');
                    return
                }

                data['newKey'] = btoa(newUsername + ':' + newPassword);
            }

            $.ajax('/save_password', {
                method: 'POST',
                data: JSON.stringify(data),
                success: function (message) {
                    alert(message);
                    $('#changePasswordModal').modal('hide');
                },
                error: appendErrorLog
            });
        }

        function checkUpdate() {
            $('#updateModal').modal('show');
            $('#consoleLog').html('');
            $('#updateButton').addClass('disabled');

            appendConsoleLog('Check for updates ...', 'green');

            $.ajax('/check_update', {
                method: 'POST',
                dataType: 'json',
                success: function (data) {
                    if (data['is_update_available']) {
                        $('#updateButton').removeClass('disabled');
                    }
                },
                error: appendErrorLog
            });
        }

        function updateSystem() {
            $.ajax('/update', {
                method: 'POST',
                error: appendErrorLog
            });
        }

        // Append the message, which can be a an array, to the console output.
        function appendConsoleLogMessage(message, colour='black') {
            if (message.includes('Error:')) {
                colour = 'red';
            }

            $('#consoleLog').append($('<span>').css('color', colour).text(message)).append($('<br>'))
            $("#consoleLog").scrollTop($("#consoleLog")[0].scrollHeight);
        }

    </script>

<head>
</head>
<body id="body">

    <div class="container">

        <div id="headerArea">
            <button onclick="window.open('https://github.com/juwis/hackerschool')" class="circular ui icon button" style="position: relative;">
                <i class="icon github"></i>
                <div class="floating ui blue label" id="version">error</div>
                GitHub
            </button>
        </div>

        <div class="center">
            <button onclick="$('#changePasswordModal').modal('show')" class="fluid ui orange button">
                <i class="icon key"></i>
                Change Password
            </button>
            <p></p>
            <button onclick="checkUpdate()" class="fluid ui orange button">
                <i class="icon cloud download"></i>
                Update
            </button>
            <p></p>
            <button onclick="location.href='index.html'" class="fluid ui blue button">
                <i class="icon home"></i>
                Home
            </button>
        </div>

    </div>

    <div id="changePasswordModal" class="ui modal">
        <div class="header">
            <i class="icon key"></i>
            Change Password
        </div>

        <div class="content">
            <div class="ui form">

                <h4 class="ui dividing header">Current Name / Password</h4>
                <div class="field">
                    <div class="two fields">
                        <div class="field">
                            <input type="text" id="current_username" placeholder="Name">
                        </div>
                        <div class="field">
                            <input type="password" id="current_password" placeholder="Password">
                        </div>
                    </div>
                </div>

                <h4 class="ui dividing header">New Name / Password</h4>
                <div class="field">
                    <div class="two fields">
                        <div class="field">
                            <input type="text" id="new_username" placeholder="Name">
                        </div>
                        <div class="field">
                            <input type="password" id="new_password" placeholder="Password">
                            <input type="password" id="new_password_confirm" placeholder="Confirm Password">
                        </div>
                    </div>
                </div>

                <button onclick="$('#changePasswordModal').modal('hide')" class="ui orange button" type="cancel">Cancel</button>
                <button onclick="savePassword(true)" class="ui red button">Remove password</button>
                <button onclick="savePassword(false)" class="ui blue right button">Save</button>
            </div>
        </div>
    </div>

    <div id="updateModal" class="ui modal">
        <div class="header">
            <i class="icon cloud download"></i>
            Update
        </div>

        <div class="content">
            <div id="consoleLog" class="codeText" style="height: 300px; overflow-y: scroll;"></div>

            <button onclick="$('#updateModal').modal('hide')" class="ui orange button">Close</button>
            <button onclick="updateSystem()" id="updateButton" class="ui blue button disabled">Update</button>
        </div>
    </div>

</body>
</html>